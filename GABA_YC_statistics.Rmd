---
title: 'GABA-AD: Effect of pharmacological actvation of GABAARs'
output: 
  html_notebook:
    theme: 
      bootswatch: minty
    toc: TRUE
chunk_output_type: inline
---

```{r chunk_setup, include = FALSE, eval = TRUE}
knitr::opts_chunk$set(echo = T, message = F, warning = F, comment = NA, autodep = F, eval = T, cache.rebuild = F, cache = T, R.options = list(width = 120), fig.width = 8, fig.align = 'center', dev.args = list(bg = 'transparent'), dev = 'svglite')
```

## **STUDY DESCRIPTION**
### Hypothesis

### Experimental design

### Outcome variables
- **TEP peak amplitude**: measured separately for each TEP component (5 components) and stimulus (3 M1 TEPs sub- and supra-threshold, AG TEPs)
- **RS-EEG**: 4 DVs
  - mean power across the lower beta band = **sigma**
  - mean power across the delta band = **delta**
  - **Alpha Attenuation Coefficient** (eyes closed/eyes open)
  - **Spectral Exponent** of the 1/f slope
        
All outcome variables are presented as the difference between the value post-medication and the value at baseline

### Fixed effect
- **MEDICATION** - binomial 
  0. placebo = control condition
  1. amplrazolam
  
- Covariate: **rMT change** - continuous value

### Hierarchy in the model
- 2 levels
- nested within **SUBJECT**

## **STATISTICAL ANALYSIS**
Following pipeline treats each outcome measure separately, as an independent measure

### Setup
```{r setup, include = FALSE, eval = TRUE}
# report 3 significant digits
options(digits = 3)    

# load packages
library(skimr)
library(moments)
library(rstatix)
library(tidyverse)
library(ggpubr)
library(corrplot) 
library(visreg) 
library(knitr)
library(readr)
library(nlme)
library(car)

# directories
folder_dir <- choose.dir(default = getwd(), caption = "Select folder for input/output")
figures_dir <- paste(folder_dir, '\\figures', sep = "")
if(file.exists(figures_dir)){
  setwd(folder_dir)
}else {
    dir.create(figures_dir)
  }

# color palette - red/blue/purple/green(light + dark)
col_palette = c('cadetblue1', 'turquoise4', 'tomato1', 'red3', 'mediumorchid1', 'darkmagenta', 'olivedrab3', 'olivedrab4')
```

### Import data
Choose a .csv file with either TEP or rsEEG data. 
```{r data}
# import the data
input_file <- choose.files(default = folder_dir, caption = "Select the dataset")
data_all <- as_tibble(read.csv(input_file))
names(data_all)
summary(data_all)
```

### Variable of interest
```{r variable}
# choose the variable of interest
outcome_var <- readline(prompt = "Variable of interest: ")
if('rMT' %in% names(data_all)){
  data_type <- 'TEP'
  vars2keep <- c('subject', 'medication', outcome_var, 'rMT')
} else {
  data_type <- 'rsEEG'
  vars2keep <- c('subject', 'medication', outcome_var)
}

# subset the dataset
data <- data_all[vars2keep] %>% 
  mutate(subject = factor(subject)) %>% 
  mutate(medication = factor(medication, levels=c('placebo', 'alprazolam'), ordered = TRUE)) %>% 
  rename(DV_change = as.name(outcome_var))
str(data)
```

### Descriptive statistics 
The distribution is described and visualized for both levels of the factor 'medication' separately.
The normality is checked both visually (histogram, QQ-plot) and using the Shapiro-Wilk normality test. 
```{r desctiptives}
# ---- DISTRIBUTION ----
# get summary per medication
data %>% 
  select(c(DV_change, medication)) %>% 
  group_by(medication) %>% 
  skim()

# calculate mean and median
data_mean <- data %>% 
  group_by(medication) %>% 
  summarise(mean = mean(DV_change), median = median(DV_change))
data_mean %>% 
  knitr::kable()

# plot by mediation
data %>% 
  ggplot(aes(x = DV_change, y = ..count.., fill = medication)) +
  geom_histogram(binwidth = 1, col = 'white', alpha = 0.5) +
  geom_density(alpha = 0, size = 1) +
  facet_grid(medication ~ .) + 
  geom_vline(data = data_mean, aes(xintercept = median), linetype = 'dashed', size = 1) + 
  geom_vline(data = data_mean, aes(xintercept = mean), size = 1) + 
  ggtitle('original data') +
  ylab('count') +
  xlab('dependent variable') + 
  theme(text = element_text(size = 15), legend.position = 'none') + 
  scale_fill_manual(values = col_palette[c(2, 4)]) 

# skewness and kurtosis
data_shape <- data %>% 
  group_by(medication) %>% 
  summarise(skewness = skewness(DV_change), kurtosis = kurtosis(DV_change))
data_shape %>% 
  knitr::kable()

# ---- NORMALITY TEST ----
# parameters for the fitted line
slopes <- numeric()
ints <- numeric()
for(i in levels(factor(data$medication))) {
  slopes[i] <- diff(quantile(data$DV_change[data$medication == i],
                            probs = c(0.25, 0.75))) / diff(qnorm(c(0.25, 0.75)))
  ints[i] <- quantile(data$DV_change[data$medication == i],
                     probs = c(0.25)) - slopes[i] * qnorm(c(0.25))
}
params <- data.frame(medication = levels(data$medication), 
                     a = slopes,
                     b = ints)
rm(slopes, ints)

# QQ-plot
data %>% 
  ggplot(aes(sample = DV_change, col = medication)) + 
  geom_abline(data = params %>% group_by(medication), 
              aes(slope = a, intercept = b), lwd = 1, lty = 2, color = 'black') +
  geom_qq(size = 2.5) + 
  facet_grid(. ~ medication) + 
  scale_color_manual(values = col_palette[c(2, 4)]) 

# Shapiro-Wilk test
data %>% 
  group_by(medication) %>% 
  shapiro_test(DV_change)

```

### Data transformation
Transformations are applied only when needed - in the case of a non-normal distribution.
The code below tests two possible transformations - square root and log transform with the base 2 - and their effect on the final distribution.
```{r transformation}
# constants --> onset to positive values
c <- -min(data$DV_change) + 1
data_trans <- data %>% 
  mutate(DV_change = DV_change + c)

# reflect if negatively skewed
# data_trans <- data_trans %>%
#   group_by(medication) %>%
#   mutate(DV_change = max(data_trans$DV_change) - DV_change + 1)

# ---- SQUARE ROOT ----
# create new variable
data_trans <- data_trans %>% 
  mutate(DV_sqrt = sqrt(DV_change))

# plot by mediation
data_trans %>% 
  ggplot(aes(x = DV_sqrt, y = ..count.., fill = medication)) +
  geom_histogram(binwidth = 1, col = 'white', alpha = 0.5) +
  geom_density(alpha = 0, size = 1) +
  facet_grid(medication ~ .) + 
  ggtitle('square-rooted data') +
  ylab('count') +
  xlab('dependent variable') + 
  theme(text = element_text(size = 15), legend.position = 'none') + 
  scale_fill_manual(values = col_palette[c(2, 4)]) 

# Shapiro-Wilk test
data_trans %>% 
  group_by(medication) %>% 
  shapiro_test(DV_sqrt)

# ---- LOG TRANSFORM ----
# create new variable
data_trans <- data_trans %>% 
  mutate(DV_log2 = log2(DV_change))

# plot by mediation
data_trans %>% 
  ggplot(aes(x = DV_log2, y = ..count.., fill = medication)) +
  geom_histogram(binwidth = 1, col = 'white', alpha = 0.5) +
  geom_density(alpha = 0, size = 1) +
  facet_grid(medication ~ .) + 
  ggtitle('log-transformed data') +
  ylab('count') +
  xlab('dependent variable') + 
  theme(text = element_text(size = 15), legend.position = 'none') + 
  scale_fill_manual(values = col_palette[c(2, 4)]) 

# Shapiro-Wilk test
data_trans %>% 
  group_by(medication) %>% 
  shapiro_test(DV_log2)
```

### Outlier rejection
If a serious outlier is identified, the subject might be removed from the dataset. This step is an option if transformations don't prove helpful.
```{r outlier rejetion}
# outlier threshold 
out_threshold <- data %>% 
  group_by(medication) %>% 
  summarize(a = quantile(DV_change, 0.75) - 1.5*IQR(DV_change), b = quantile(DV_change, 0.75) + 1.5*IQR(DV_change))
out_threshold %>% 
  knitr::kable()

# idenntify outliers
outliers <- boxplot.stats(data %>% group_by(medication) %>% pull(DV_change))$out
outliers_index <- which(data %>% group_by(medication) %>% pull(DV_change) %in% c(outliers))
data[outliers_index,]
remove_subj <- data$subject[outliers_index[c(2)]]

# boxplot
data %>% 
  ggplot(aes(medication, DV_change, col = medication)) + 
  geom_jitter(width = 0.2, size = 2.5, show.legend = FALSE) + 
  scale_color_manual(values = col_palette[c(2, 4)]) + 
  geom_boxplot(col = 'black', alpha = 0, width = 0.5) + 
  ylab('dependent variable') +
  xlab('medication') + 
  theme(text = element_text(size = 15))

# plot by medication
data %>% 
  filter(subject != remove_subj) %>% 
  ggplot(aes(x = DV_change, y = ..count.., fill = medication)) +
  geom_histogram(binwidth = 1, col = 'white', alpha = 0.5) +
  geom_density(alpha = 0, size = 1) +
  facet_grid(medication ~ .) + 
  ggtitle('data without outliers') +
  ylab('count') +
  xlab('dependent variable') + 
  theme(text = element_text(size = 15), legend.position = 'none') + 
  scale_fill_manual(values = col_palette[c(2, 4)]) 

# Shapiro-Wilk test
data %>% 
  filter(subject != remove_subj) %>% 
  group_by(medication) %>% 
  shapiro_test(DV_change)

```

### Build models and compare
Build progressive levels of LMM models and compare them against each other: (1) a model with a random intercept only, (2) the predictor variablle added (3), the covariate added (for TEPs), (4) random slope added.
```{r models}
#  ---- DATA ----
# choose transformation if necessary
trans <- readline(prompt = "Use transformation: ")
if(trans == 'sqrt'){
  data <- data %>%
    mutate(DV_model = data_trans$DV_sqrt)
}
if(trans == 'log'){
  data <- data %>%
  mutate(DV_model = data_trans$DV_log2)
}
if(trans == 'none'){
  data <- data %>%
  mutate(DV_model = DV_change)
}

# remove outliers if necessary
out <- askYesNo('D you want to filter out ouliers?')
if(out){
  data <- filter(data, !subject %in% remove_subj)
}

# center the covariate (TEPs only)
rMT_centered <- vector()
for(i in 1:length(data$rMT)){
  if(data$medication[i] == 'placebo'){
    rMT_centered[i] <- data$rMT[i] - mean(data$rMT[data$medication == 'placebo'])
  } 
  if(data$medication[i] == 'alprazolam'){
    rMT_centered[i] <- data$rMT[i] - mean(data$rMT[data$medication == 'alprazolam'])
  }
} 
data$rMT_centered <- rMT_centered

# ---- MODELS ----
# random intercept
model_ri <- lme(
  DV_model ~ 1,
  random = ~ 1|subject,
  data = data,
  method = 'ML'
)
summary(model_ri)

# add predictor
model_rip <- lme(
  DV_model ~ medication,
  random = ~ 1|subject,
  data = data,
  method = 'ML'
)
summary(model_rip)

# full model
if(data_type == 'TEP'){
  # add covariate
  model_ripco <- lme(
    DV_model ~ medication + rMT_centered,
    random = ~ 1|subject,
    data = data,
    method = 'ML'
  )
  summary(model_ripco)
  
  # add random slope
  model_ripcors <- lme(
    DV_model ~ medication + rMT_centered,
    random = ~ medication|subject,
    data = data,
    method = 'ML'
  )
  summary(model_ripcors)
  
  # compare models
  anova(model_ri, model_rip, model_ripco, model_ripcors)
  
} else {
  # add random slope
  model_riprs <- lme(
    DV_model ~ medication,
    random = ~ medication|subject,
    data = data,
    method = 'ML'
  )
  summary(model_riprs)
  
  # compare models
  anova(model_ri, model_rip, model_riprs)
}

```

Describe chosen model. 
```{r final model}
# choose the model to retain
model <- model_ripco
summary(model)
  
# confidence intervals
intervals(model)

# fixed effects
broom.mixed::tidy(model, effects = 'fixed')

# fixed effects
broom.mixed::tidy(model, effects = 'ran_pars')

# residuals
plot(model)
qqnorm(model)
```

### Model interpretation
We are mostly interested in the fixed effect of medication, only controlling for 

When reporting the results (using the example variable), I would formulate them as follows:
*
A linear mixed effects model was used to analyze   and 15 months old. Their scores were modeled with fixed effects of Month and Naps (1, 2, or 3) and random error to account for the within subjects design.There was a significant effect of Month- scores increased with age (Estimate= , SE= , p= ).
*

